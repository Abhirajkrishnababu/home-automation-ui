<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Voice Home Automation Prototype</title>

<style>
/* SAME STYLING AS BEFORE â€” Keeping UI beautiful */
/* Keeping UI beautiful and clean */
* { box-sizing: border-box; font-family: system-ui; }

body {
  background:#050810;
  color:white;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.app {
  width:90%;
  max-width:900px;
  padding:24px;
  border:3px solid #555;
  border-radius:20px;
  background: radial-gradient(circle at top, #141b2d, #050810);
}

.title { font-size:1.5rem; font-weight:600; margin-bottom:10px; }

.device-box {
  margin-top:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:14px;
}

.card {
  background:#0b1120;
  border:1px solid #1f2937;
  border-radius:16px;
  padding:14px;
  transition:0.3s ease;
}

.mic-btn {
  padding:10px 20px;
  border-radius:50px;
  border:none;
  background:#2563eb;
  color:white;
  cursor:pointer;
  font-size:1rem;
  margin-bottom:10px;
}

.admin-btn {
  padding:8px 16px;
  margin-left:8px;
  border-radius:8px;
  border:1px solid #777;
  background:black;
  color:white;
  cursor:pointer;
}

.status {
  margin-top:10px;
  font-size:0.9rem;
  color:#9ca3af;
}

/* Light ON */
.light-on { background: radial-gradient(circle,#fde68a,#92400e); }
/* Fan ON */
.fan-on { background: radial-gradient(circle,#bbf7d0,#166534); }
/* Charging ON */
.charge-on { background: radial-gradient(circle,#a7f3d0,#047857); }
/* Lock ON */
.lock-on { background: radial-gradient(circle,#fecaca,#7f1d1d); }

/* Diwali Border Animation */
.diwali {
  animation: rainbow 3s linear infinite;
}

@keyframes rainbow {
  0% { border-color:red; }
  16% { border-color:orange; }
  32% { border-color:yellow; }
  48% { border-color:green; }
  64% { border-color:blue; }
  80% { border-color:indigo; }
  100% { border-color:violet; }
}
</style>

</head>

<body>

<div class="app" id="appShell">
  <div class="title">AI Voice Controlled Home Automation</div>

  <!-- ADMIN SETUP -->
  <button class="admin-btn" onclick="registerAdmin()">Register Admin Voice</button>
  <button class="admin-btn" onclick="resetAdmin()">Reset Admin</button>

  <!-- MIC BUTTON -->
  <button class="mic-btn" onclick="startRecording()">ðŸŽ¤ Speak Command</button>

  <div class="status" id="statusBox">System Readyâ€¦</div>

  <!-- DEVICE STATUS -->
  <div class="device-box">
    <div id="lightCard" class="card">Lights: OFF</div>
    <div id="fanCard" class="card">Fan: OFF</div>
    <div id="chargeCard" class="card">Charging: OFF</div>
    <div id="lockCard" class="card">Door Lock: UNLOCKED</div>
  </div>
</div>

<script>
let adminRegistered = false;
let isRecordingAdmin = false;

async function registerAdmin() {
  document.getElementById("statusBox").innerText = "Recording admin voiceâ€¦";
  isRecordingAdmin = true;
  await startRecording();
}

function resetAdmin() {
  adminRegistered = false;
  alert("Admin voice reset. Please register again.");
}

// ðŸŽ¤ Record User Voice
async function startRecording() {
  document.getElementById("statusBox").innerText = "Listeningâ€¦ Please speak.";

  let stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  let mediaRecorder = new MediaRecorder(stream);
  let audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    let audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    if (isRecordingAdmin) {
      isRecordingAdmin = false;
      document.getElementById("statusBox").innerText = "Registering admin voiceâ€¦";

      await uploadAudio(audioBlob, "/register_admin");
      adminRegistered = true;
      alert("Admin Voice Registered Successfully!");
      return;
    }

    if (!adminRegistered) {
      alert("Please register admin first!");
      return;
    }

    await uploadAudio(audioBlob, "/process_command");
  };

  mediaRecorder.start();

  setTimeout(() => {
    mediaRecorder.stop();
  }, 3000);
}

// Upload recording to backend
async function uploadAudio(blob, endpoint) {
  let fd = new FormData();
  fd.append("audio", blob);

  document.getElementById("statusBox").innerText = "Processingâ€¦";

  // TODO: Next message â†’ I will give full FastAPI backend code
  // For now we simulate backend response:

  simulateBackend(endpoint);
}

function simulateBackend(endpoint) {
  if (endpoint === "/register_admin") {
    document.getElementById("statusBox").innerText = "Admin voice saved.";
    return;
  }

  // random command simulation
  const commands = ["turn on light", "turn off fan", "lock door", "happy diwali"];
  let random = commands[Math.floor(Math.random() * commands.length)];

  applyCommand(random);
}

// Apply command to UI
function applyCommand(text) {
  let cmd = text.toLowerCase();
  let status = document.getElementById("statusBox");

  if (cmd.includes("happy diwali")) {
    document.getElementById("appShell").classList.add("diwali");
    status.innerText = "Happy Diwali! ðŸŽ‰ Layout animated.";
    return;
  }

  if (cmd.includes("light") && cmd.includes("on")) {
    document.getElementById("lightCard").className = "card light-on";
    document.getElementById("lightCard").innerText = "Lights: ON";
  }
  if (cmd.includes("light") && cmd.includes("off")) {
    document.getElementById("lightCard").className = "card";
    document.getElementById("lightCard").innerText = "Lights: OFF";
  }

  if (cmd.includes("fan") && cmd.includes("on")) {
    document.getElementById("fanCard").className = "card fan-on";
    document.getElementById("fanCard").innerText = "Fan: ON";
  }
  if (cmd.includes("fan") && cmd.includes("off")) {
    document.getElementById("fanCard").className = "card";
    document.getElementById("fanCard").innerText = "Fan: OFF";
  }

  if (cmd.includes("charge") && cmd.includes("on")) {
    document.getElementById("chargeCard").className = "card charge-on";
    document.getElementById("chargeCard").innerText = "Charging: ON";
  }
  if (cmd.includes("charge") && cmd.includes("off")) {
    document.getElementById("chargeCard").className = "card";
    document.getElementById("chargeCard").innerText = "Charging: OFF";
  }

  if (cmd.includes("lock") && !cmd.includes("unlock")) {
    document.getElementById("lockCard").className = "card lock-on";
    document.getElementById("lockCard").innerText = "Door Lock: LOCKED";
  }
  if (cmd.includes("unlock") || cmd.includes("open")) {
    document.getElementById("lockCard").className = "card";
    document.getElementById("lockCard").innerText = "Door Lock: UNLOCKED";
  }

  status.innerText = "Command executed: " + text;
}
